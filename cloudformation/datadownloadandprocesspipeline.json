{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "This CloudFormation template creates the LMS-environment-specific shared infrastructure (S3 buckets, Lambda functions, Data Pipeline).",
    "Parameters": {
        "EnvironmentParameter": {
            "Type": "String",
            "Description": "Environment name",
            "Default": "dev"
        },
        "LowercaseDatasourceParameter": {
            "Type": "String",
            "Description": "Lowercase version of the data source name",
            "Default": "canvas"
        },
        "InitcapsDatasourceParameter": {
            "Type": "String",
            "Description": "Initial caps version of the data source name",
            "Default": "Canvas"
        },
        "KeypairParameter": {
            "Type": "String",
            "Description": "Keypair to install on all EC2s",
            "Default": "mypublickey-id_rsa"
        },
        "RedshiftMasterUserNameParameter": {
            "Type": "String",
            "Description": "Redshift master user (and default db) name",
            "Default": "mydatabaseadminuser"
        },
        "RedshiftMasterUserPasswordParameter": {
            "Type": "String",
            "Description": "Redshift master user password",
            "Default": "changeM3!"
        },
        "Phase0LambdaCodeObjectParameter": {
            "Type": "String",
            "Description": "Name of ZIP file in the CodeS3Bucket containing the Phase0Lambda function code",
            "Default": "phase0-lambda.zip"
        },
        "SecurePropertiesLocationParameter": {
            "Type": "String",
            "Description": "Name of secure settings file for use by the Python script (NOTE: Name must remain secure.properties for now)",
            "Default": "secure.properties"
        },
        "HDTGitTagOrBranchParameter": {
            "Type": "String",
            "Description": "harvard-data-tools git tag or branch to deploy",
            "Default": "master"
        },
        "DataSourceSchemaVersion": {
            "Type": "String",
            "Description": "Data Source Schema Version",
            "Default": "1.3.0"
        },
        "CodeS3BucketParameter": {
            "Type": "String",
            "Description": "Name of S3 bucket containing various Lambda, JAR and Hadoop code files",
            "Default": "my-bucket"
        },
        "DataPipelineInitLambdaCodeObjectParameter": {
            "Type": "String",
            "Description": "Name of ZIP file in the CodeS3Bucket containing the DataPipelineInitLambda function code",
            "Default": "data-pipeline-init-lambda.zip"
        },
        "SuccessSNSEmailParameter": {
            "Type": "String",
            "Description": "Email address to receive success messages",
            "Default": "success@example.com"
        },
        "FailureSNSEmailParameter": {
            "Type": "String",
            "Description": "Email address to receive failure messages",
            "Default": "failure@example.com"
        },
        "VPCIDParameter": {
            "Type": "String",
            "Description": "VPC ID",
            "Default": "vpc-34567890"
        },
        "PrivateAppSubnetParameter": {
            "Type": "String",
            "Description": "Private subnet ID containing the application EC2s",
            "Default": "subnet-56789012"
        },
        "Phase0AMIIdParameter": {
            "Type": "String",
            "Description": "AMI Id to use for the Phase 0 Instance(s) (NOTE: Should be instance store AMI, not EBS, for maximum speed)",
            "Default": "ami-66b6c60c"
        },
        "Phase0InstanceTypeParameter": {
            "Type": "String",
            "Description": "Instance type for Phase 0 Instance(s)",
            "Default": "i2.8xlarge"
        },
        "EMRMasterInstanceTypeParameter": {
            "Type": "String",
            "Description": "Instance type for the Master EMR Instance",
            "Default": "m3.xlarge"
        },
        "EMRMasterInstanceBidPriceParameter": {
            "Type": "String",
            "Description": "Maximum dollar amount for a Spot Instance bid for the Master EMR Instance",
            "Default": "0.00"
        },
        "EMRCoreInstanceTypeParameter": {
            "Type": "String",
            "Description": "Instance type for Core EMR Instance(s)",
            "Default": "m3.xlarge"
        },
        "EMRCoreInstanceCountParameter": {
            "Type": "String",
            "Description": "Number of Core EMR Instances",
            "Default": "1"
        },
        "EMRCoreInstanceBidPriceParameter": {
            "Type": "String",
            "Description": "Maximum dollar amount for a Spot Instance bid for Core EMR Instance(s)",
            "Default": "0.00"
        },
        "EMRTaskInstanceTypeParameter": {
            "Type": "String",
            "Description": "Instance type for Task EMR Instance(s)",
            "Default": "m3.xlarge"
        },
        "EMRTaskInstanceCountParameter": {
            "Type": "String",
            "Description": "Number of Task EMR Instances",
            "Default": "1"
        },
        "EMRTaskInstanceBidPriceParameter": {
            "Type": "String",
            "Description": "Maximum dollar amount for a Spot Instance bid for Task EMR Instance(s)",
            "Default": "0.00"
        },
        "EMRReleaseLabelParameter": {
            "Type": "String",
            "Description": "EMR release label to be used",
            "Default": "emr-4.5.0"
        },
        "RedshiftClusterParameter": {
            "Type": "String",
            "Description": "Redshift Cluster name for this environment",
            "Default": "hdtdev-redshiftcluster-abcd1234wxyz"
        }
    },
    "Mappings": {},
    "Conditions": {},
    "Resources": {
        "Phase0LambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "-",
                                    {
                                        "Ref": "EnvironmentParameter"
                                    },
                                    "-Phase0LambdaRole-policy"
                                ]
                            ]
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "Stmt1449002131000",
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudformation:Describe*",
                                        "autoscaling:UpdateAutoScalingGroup",
                                        "autoscaling:SetDesiredCapacity",
                                        "sns:Publish"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "-",
                                    {
                                        "Ref": "EnvironmentParameter"
                                    },
                                    "-enable-log-access"
                                ]
                            ]
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "arn:aws:logs:*:*:*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "Phase0ResourceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "-",
                                    {
                                        "Ref": "EnvironmentParameter"
                                    },
                                    "-Phase0ResourceRole-policy"
                                ]
                            ]
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:DescribeTags",
                                        "autoscaling:UpdateAutoScalingGroup",
                                        "lambda:Invoke*",
                                        "dynamodb:*",
                                        "s3:Get*",
                                        "s3:List*",
                                        "s3:Put*",
                                        "sns:Publish",
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "Phase0ResourceInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "Phase0ResourceRole"
                    }
                ]
            }
        },
        "DataPipelineInitLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "-",
                                    {
                                        "Ref": "EnvironmentParameter"
                                    },
                                    "-DataPipelineInitLambdaRole-policy"
                                ]
                            ]
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "Stmt1449002131000",
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudformation:Describe*",
                                        "datapipeline:*",
                                        "iam:PassRole"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "-",
                                    {
                                        "Ref": "EnvironmentParameter"
                                    },
                                    "-enable-log-access"
                                ]
                            ]
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "arn:aws:logs:*:*:*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "DataPipelineResourceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "-",
                                    {
                                        "Ref": "EnvironmentParameter"
                                    },
                                    "-DataPipelineResourceRole-policy"
                                ]
                            ]
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:*",
                                        "datapipeline:*",
                                        "dynamodb:*",
                                        "ec2:Describe*",
                                        "elasticmapreduce:AddJobFlowSteps",
                                        "elasticmapreduce:Describe*",
                                        "elasticmapreduce:ListInstance*",
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents",
                                        "rds:Describe*",
                                        "redshift:DescribeClusters",
                                        "redshift:DescribeClusterSecurityGroups",
                                        "s3:*",
                                        "sdb:*",
                                        "sns:*",
                                        "sqs:*"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "DataPipelineResourceInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "DataPipelineResourceRole"
                    }
                ]
            }
        },
        "DataPipelineRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "elasticmapreduce.amazonaws.com",
                                    "datapipeline.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "-",
                                    {
                                        "Ref": "EnvironmentParameter"
                                    },
                                    "-DataPipelineRole-policy"
                                ]
                            ]
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:*",
                                        "datapipeline:DescribeObjects",
                                        "datapipeline:EvaluateExpression",
                                        "dynamodb:BatchGetItem",
                                        "dynamodb:DescribeTable",
                                        "dynamodb:GetItem",
                                        "dynamodb:Query",
                                        "dynamodb:Scan",
                                        "dynamodb:UpdateTable",
                                        "ec2:AuthorizeSecurityGroupIngress",
                                        "ec2:CancelSpotInstanceRequests",
                                        "ec2:CreateSecurityGroup",
                                        "ec2:CreateTags",
                                        "ec2:DeleteTags",
                                        "ec2:Describe*",
                                        "ec2:ModifyImageAttribute",
                                        "ec2:ModifyInstanceAttribute",
                                        "ec2:RequestSpotInstances",
                                        "ec2:RunInstances",
                                        "ec2:StartInstances",
                                        "ec2:StopInstances",
                                        "ec2:TerminateInstances",
                                        "ec2:*",
                                        "elasticmapreduce:*",
                                        "iam:GetInstanceProfile",
                                        "iam:GetRole",
                                        "iam:GetRolePolicy",
                                        "iam:ListAttachedRolePolicies",
                                        "iam:ListRolePolicies",
                                        "iam:ListInstanceProfiles",
                                        "iam:PassRole",
                                        "rds:DescribeDBInstances",
                                        "rds:DescribeDBSecurityGroups",
                                        "redshift:DescribeClusters",
                                        "redshift:DescribeClusterSecurityGroups",
                                        "s3:CreateBucket",
                                        "s3:DeleteObject",
                                        "s3:Get*",
                                        "s3:List*",
                                        "s3:Put*",
                                        "sdb:BatchPutAttributes",
                                        "sdb:Select*",
                                        "sns:GetTopicAttributes",
                                        "sns:ListTopics",
                                        "sns:Publish",
                                        "sns:Subscribe",
                                        "sns:Unsubscribe",
                                        "sqs:CreateQueue",
                                        "sqs:Delete*",
                                        "sqs:GetQueue*",
                                        "sqs:PurgeQueue",
                                        "sqs:ReceiveMessage"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "RedshiftOperationsUser": {
            "Type": "AWS::IAM::User",
            "Properties": {
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "-",
                                    {
                                        "Ref": "EnvironmentParameter"
                                    },
                                    "-S3toRedshiftLoad-policy"
                                ]
                            ]
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:Get*",
                                        "s3:List*"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "arn:aws:s3:::",
                                                    {
                                                        "Ref": "IntermediateS3Bucket"
                                                    }
                                                ]
                                            ]
                                        },
                                        {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "arn:aws:s3:::",
                                                    {
                                                        "Ref": "IntermediateS3Bucket"
                                                    },
                                                    "/*"
                                                ]
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:Get*",
                                        "s3:List*",
                                        "s3:Put*"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "arn:aws:s3:::",
                                                    {
                                                        "Ref": "IncomingS3Bucket"
                                                    }
                                                ]
                                            ]
                                        },
                                        {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    "arn:aws:s3:::",
                                                    {
                                                        "Ref": "IncomingS3Bucket"
                                                    },
                                                    "/*"
                                                ]
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "RedshiftOperationsAccessKey": {
            "Type": "AWS::IAM::AccessKey",
            "Properties": {
                "Status": "Active",
                "UserName": {
                    "Ref": "RedshiftOperationsUser"
                }
            }
        },
        "Phase0LC": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "ImageId": {
                    "Ref": "Phase0AMIIdParameter"
                },
                "InstanceType": {
                    "Ref": "Phase0InstanceTypeParameter"
                },
                "IamInstanceProfile": {
                    "Ref": "Phase0ResourceInstanceProfile"
                },
                "InstanceMonitoring": "False",
                "KeyName": {
                    "Ref": "KeypairParameter"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash\n",
                                "\n",
                                "# - HARVARD_DATA_TOOLS_BASE: the directory where the harvard-data-tools\n",
                                "#     repository has been checked out. Point to the root of the repository, e.g.\n",
                                "#     /tmp/code/harvard-data-tools\n",
                                "export HARVARD_DATA_TOOLS_BASE=/root/harvard-data-tools\n",
                                "\n",
                                "# - SECURE_PROPERTIES_LOCATION: a directory containing the secure.properties\n",
                                "#     file modelled after the template in:\n",
                                "#     java/aws_data_tools/src/main/resources/secure.properties.example\n",
                                "export SECURE_PROPERTIES_LOCATION=/root\n",
                                "\n",
                                "# - HARVARD_DATA_GENERATED_OUTPUT: the directory where generated scripts and\n",
                                "#     .jar files should be stored.\n",
                                "export HARVARD_DATA_GENERATED_OUTPUT=/root\n",
                                "\n",
                                "# - DATA_SCHEMA_VERSION: The version of the Canvas Data schema for which\n",
                                "#     files will be generated. Format as a string, e.g. 1.2.0\n",
                                "export DATA_SCHEMA_VERSION=",
                                {
                                    "Ref": "DataSourceSchemaVersion"
                                },
                                "\n",
                                "# - CANVAS_DATA_DUMP_ID: the UUID of a particular data dump. Uncomment this environment\n",
                                "#     variable setting to skip the download and perform only the verify portion of the process.\n",
                                "#export CANVAS_DATA_DUMP_ID=143b91b2-e9c4-4c76-8033-00176520bce5\n",
                                "\n",
                                "\n",
                                "# add github.com to known_hosts and run ansible-pull\n",
                                "ssh-keyscan github.com >> /root/.ssh/known_hosts\n",
                                "\n",
                                "# install jdk and git\n",
                                "yum install -y java-devel git-core\n",
                                "\n",
                                "# clone our repo\n",
                                "git clone -b ",
                                {
                                    "Ref": "HDTGitTagOrBranchParameter"
                                },
                                " https://github.com/penzance/harvard-data-tools.git /root/harvard-data-tools\n",
                                "\n",
                                "# setup CloudWatch logging\n",
                                "yum install -y awslogs\n",
                                "\\cp /root/harvard-data-tools/cloudwatch/awslogs-phase0.conf /etc/awslogs/awslogs.conf\n",
                                "service awslogs start\n",
                                "\n",
                                "#Install maven via instructions at https://gist.github.com/sebsto/19b99f1fa1f32cae5d00\n",
                                "wget http://repos.fedorapeople.org/repos/dchen/apache-maven/epel-apache-maven.repo -O /etc/yum.repos.d/epel-apache-maven.repo\n",
                                "sed -i s/\\$releasever/6/g /etc/yum.repos.d/epel-apache-maven.repo\n",
                                "yum install -y apache-maven\n",
                                "\n",
                                "# copy SecureProperties from S3 to the local FS\n",
                                "aws s3 cp s3://",
                                {
                                    "Ref": "CodeS3BucketParameter"
                                },
                                "/",
                                {
                                    "Ref": "LowercaseDatasourceParameter"
                                },
                                "/",
                                {
                                    "Ref": "SecurePropertiesLocationParameter"
                                },
                                " /root/.\n",
                                "\n",
                                "# generate the tools\n",
                                "python /root/harvard-data-tools/python/",
                                {
                                    "Ref": "LowercaseDatasourceParameter"
                                },
                                "_generate_tools.py &> /root/generate-tools.out\n",
                                "\n",
                                "# setup some environment variables\n",
                                "export CANVAS_DATA_RESULT_FILE=/root/the_result.json\n",
                                "\n",
                                "export DATA_THREAD_COUNT=32\n",
                                "\n",
                                "# TO DO: Implement a good way to parameterize this\n",
                                "#export CANVAS_DATA_DUMP_ID=\n",
                                "\n",
                                "# Run the Python/JAR phase 0 scripts\n",
                                "python /root/harvard-data-tools/python/",
								{
									"Ref": "LowercaseDatasourceParameter"
								},
                                "_phase_0.py &> /var/log/phase0-output.log\n",
                                "if [ $? -ne 0 ]; then\n",
                                "  # do something useful to indicate failure\n",
                                "  aws sns publish --topic-arn \"",
                                {
                                    "Ref": "FailureSNS"
                                },
                                "\" --message file:///var/log/phase0-output.log --subject \"$(curl http://169.254.169.254/latest/meta-data/instance-id): Phase 0 failed\" --region us-east-1\n",
                                "\n",
                                "# Reduce max instances for this machine's ASG to 0, thus terminating the machine\n",
                                "asg=$(aws ec2 describe-tags --filters \"Name=resource-id,Values=$(curl http://169.254.169.254/latest/meta-data/instance-id)\" \"Name=key,Values=aws:autoscaling:groupName\" --query 'Tags[*].[Value]' --output text --region us-east-1); aws autoscaling update-auto-scaling-group --auto-scaling-group-name $asg --max-size 0 --region us-east-1\n",
                                "\n",
                                "  exit\n",
                                "fi\n",
                                "\n",

                                "if [ \"matterhorn\" == \"",
								{
									"Ref": "LowercaseDatasourceParameter"
								},
                                "\" ]; then\n",
                                "cat <<EOF > /root/the_result.json\n",
                                "{\n",
                                "    \"AWS_KEY\" : \"\",\n",
                                "    \"AWS_BUCKET\" : \"",
								{
									"Ref": "IncomingS3Bucket"
								},
                                "\",\n",
                                "    \"DUMP_SEQUENCE\" : \"\",\n",
                                "    \"DUMP_ID\" : \"this-is-a-fake-dump-id\"\n",
                                "}\n",
                                "EOF\n",
                                "fi\n",
                                "\n",

                                "# Send an email that we completed Phase 0\n",
                                "aws sns publish --topic-arn \"",
                                {
                                    "Ref": "SuccessSNS"
                                },
                                "\" --message file:///root/the_result.json --subject \"Phase 0 succeeded\" --region us-east-1\n",
                                "\n",
                                "# Invoke the Lambda function to kickoff the Data Pipeline\n",
                                "aws lambda invoke --function-name ",
                                {
                                    "Ref": "DataPipelineInitLambda"
                                },
                                " --payload file:///root/the_result.json myoutfile --region us-east-1\n",
                                "\n",
                                "# Reduce max instances for this machine's ASG to 0, thus terminating the machine\n",
                                "asg=$(aws ec2 describe-tags --filters \"Name=resource-id,Values=$(curl http://169.254.169.254/latest/meta-data/instance-id)\" \"Name=key,Values=aws:autoscaling:groupName\" --query 'Tags[*].[Value]' --output text --region us-east-1); aws autoscaling update-auto-scaling-group --auto-scaling-group-name $asg --max-size 0 --region us-east-1\n"
                            ]
                        ]
                    }
                }
            }
        },
        "Phase0ASG": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "LaunchConfigurationName": {
                    "Ref": "Phase0LC"
                },
                "MinSize": "0",
                "MaxSize": "0",
                "DesiredCapacity": "0",
                "VPCZoneIdentifier": [
                    {
                        "Ref": "PrivateAppSubnetParameter"
                    }
                ],
                "Tags": [
                    {
                        "PropagateAtLaunch": "True",
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "-",
                                    {
                                        "Ref": "EnvironmentParameter"
                                    },
                                    "-Phase0"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "Phase0Lambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": {
                        "Ref": "CodeS3BucketParameter"
                    },
                    "S3Key": {
						"Fn::Join": [
							"",
							[
								{
									"Ref": "LowercaseDatasourceParameter"
								},
								"/",
								{
									"Ref": "Phase0LambdaCodeObjectParameter"
								}
							]
						]
                    }
                },
                "Description": {
                    "Fn::Join": [
                        "",
                        [
                            "Function to kick off Phase 0 for ",
                            {
                                "Ref": "AWS::StackName"
                            },
                            "-",
                            {
                                "Ref": "EnvironmentParameter"
                            }
                        ]
                    ]
                },
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "Phase0LambdaRole",
                        "Arn"
                    ]
                },
                "Runtime": "nodejs4.3",
                "Timeout": 10
            }
        },
        "DataPipelineInitLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": {
                        "Ref": "CodeS3BucketParameter"
                    },
                    "S3Key": {
						"Fn::Join": [
							"",
							[
								{
									"Ref": "LowercaseDatasourceParameter"
								},
								"/",
								{
									"Ref": "DataPipelineInitLambdaCodeObjectParameter"
								}
							]
						]
                    }
                },
                "Description": {
                    "Fn::Join": [
                        "",
                        [
                            "Function to kick off Data Pipeline for ",
                            {
                                "Ref": "AWS::StackName"
                            },
                            "-",
                            {
                                "Ref": "EnvironmentParameter"
                            }
                        ]
                    ]
                },
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "DataPipelineInitLambdaRole",
                        "Arn"
                    ]
                },
                "Runtime": "nodejs4.3",
                "Timeout": 60
            }
        },
        "DataPipelineInitLambdaInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Fn::GetAtt": [
                        "DataPipelineInitLambda",
                        "Arn"
                    ]
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "ec2.amazonaws.com",
                "SourceArn": "arn:aws:ec2:::*"
            }
        },
        "NewCodeS3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "Tags": [
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentParameter"
                        }
                    }
                ]
            }
        },
        "DropboxS3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "Tags": [
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentParameter"
                        }
                    }
                ]
            }
        },
        "IncomingS3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "Tags": [
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentParameter"
                        }
                    }
                ]
            }
        },
        "IntermediateS3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "Tags": [
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentParameter"
                        }
                    }
                ]
            }
        },
        "ArchivalS3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "Tags": [
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentParameter"
                        }
                    }
                ]
            }
        },
        "LoggingS3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "Tags": [
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentParameter"
                        }
                    }
                ]
            }
        },
        "SuccessSNS": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "DisplayName": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            {
                                "Ref": "EnvironmentParameter"
                            },
                            "success"
                        ]
                    ]
                },
                "Subscription": [
                    {
                        "Endpoint": {
                            "Ref": "SuccessSNSEmailParameter"
                        },
                        "Protocol": "email"
                    }
                ]
            }
        },
        "FailureSNS": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "DisplayName": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            {
                                "Ref": "EnvironmentParameter"
                            },
                            "failure"
                        ]
                    ]
                },
                "Subscription": [
                    {
                        "Endpoint": {
                            "Ref": "FailureSNSEmailParameter"
                        },
                        "Protocol": "email"
                    }
                ]
            }
        },
        "Pipeline": {
            "Type": "AWS::DataPipeline::Pipeline",
            "Properties": {
                "Activate": "False",
                "Description": {
                    "Fn::Join": [
                        "",
                        [
                            "Data Pipeline for ",
                            {
                                "Ref": "AWS::StackName"
                            },
                            "-",
                            {
                                "Ref": "EnvironmentParameter"
                            }
                        ]
                    ]
                },
                "Name": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            {
                                "Ref": "EnvironmentParameter"
                            },
                            "datapipeline"
                        ]
                    ]
                },
                "PipelineObjects": [
                    {
                        "Id": "Default",
                        "Name": "Default",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "Default"
                            },
                            {
                                "Key": "scheduleType",
                                "StringValue": "cron"
                            },
                            {
                                "Key": "failureAndRerunMode",
                                "StringValue": "CASCADE"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "resourceRole",
                                "StringValue": {
                                    "Ref": "DataPipelineResourceInstanceProfile"
                                }
                            },
                            {
                                "Key": "pipelineLogUri",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "s3://",
                                            {
                                                "Ref": "LoggingS3Bucket"
                                            }
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            }
                        ]
                    },
                    {
                        "Id": "DefaultSchedule",
                        "Name": "RunOnce",
                        "Fields": [
                            {
                                "Key": "occurrences",
                                "StringValue": "1"
                            },
                            {
                                "Key": "startAt",
                                "StringValue": "FIRST_ACTIVATION_DATE_TIME"
                            },
                            {
                                "Key": "type",
                                "StringValue": "Schedule"
                            },
                            {
                                "Key": "period",
                                "StringValue": "1 Day"
                            }
                        ]
                    },
                    {
                        "Id": "EmrConfigHiveSite",
                        "Name": "EmrConfigHiveSite",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrConfiguration"
                            },
                            {
                                "Key": "classification",
                                "StringValue": "hive-site"
                            },
                            {
                                "Key": "property",
                                "RefValue": "EmrHiveParallel"
                            }
                        ]
                    },
                    {
                        "Id": "EmrHiveParallel",
                        "Name": "EmrHiveParallel",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "Property"
                            },
                            {
                                "Key": "key",
                                "StringValue": "hive.exec.parallel"
                            },
                            {
                                "Key": "value",
                                "StringValue": "true"
                            }
                        ]
                    },
                    {
                        "Id": "EmrConfigHiveLog4J",
                        "Name": "EmrConfigHiveLog4J",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrConfiguration"
                            },
                            {
                                "Key": "classification",
                                "StringValue": "hive-log4j"
                            },
                            {
                                "Key": "property",
                                "RefValue": "EmrHiveLogs"
                            }
                        ]
                    },
                    {
                        "Id": "EmrHiveLogs",
                        "Name": "EmrHiveLogs",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "Property"
                            },
                            {
                                "Key": "key",
                                "StringValue": "hive.log.dir"
                            },
                            {
                                "Key": "value",
                                "StringValue": "/home/hadoop"
                            }
                        ]
                    },
                    {
                        "Id": "EmrCluster",
                        "Name": "EmrCluster",
                        "Fields": [
                            {
                                "Key": "masterInstanceType",
                                "StringValue": {
                                    "Ref": "EMRMasterInstanceTypeParameter"
                                }
                            },
                            {
                                "Key": "masterInstanceBidPrice",
                                "StringValue": {
                                    "Ref": "EMRMasterInstanceBidPriceParameter"
                                }
                            },
                            {
                                "Key": "coreInstanceType",
                                "StringValue": {
                                    "Ref": "EMRCoreInstanceTypeParameter"
                                }
                            },
                            {
                                "Key": "coreInstanceCount",
                                "StringValue": {
                                    "Ref": "EMRCoreInstanceCountParameter"
                                }
                            },
                            {
                                "Key": "coreInstanceBidPrice",
                                "StringValue": {
                                    "Ref": "EMRCoreInstanceBidPriceParameter"
                                }
                            },
                            {
                                "Key": "taskInstanceType",
                                "StringValue": {
                                    "Ref": "EMRTaskInstanceTypeParameter"
                                }
                            },
                            {
                                "Key": "taskInstanceCount",
                                "StringValue": {
                                    "Ref": "EMRTaskInstanceCountParameter"
                                }
                            },
                            {
                                "Key": "taskInstanceBidPrice",
                                "StringValue": {
                                    "Ref": "EMRTaskInstanceBidPriceParameter"
                                }
                            },
                            {
                                "Key": "type",
                                "StringValue": "EmrCluster"
                            },
                            {
                                "Key": "subnetId",
                                "StringValue": {
                                    "Ref": "PrivateAppSubnetParameter"
                                }
                            },
                            {
                                "Key": "keyPair",
                                "StringValue": {
                                    "Ref": "KeypairParameter"
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "releaseLabel",
                                "StringValue": {
                                    "Ref": "EMRReleaseLabelParameter"
                                }
                            },
                            {
                                "Key": "terminateAfter",
                                "StringValue": "4 Hours"
                            },
                            {
                                "Key": "useOnDemandOnLastAttempt",
                                "StringValue": "true"
                            },
                            {
                                "Key": "bootstrapAction",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "s3://",
                                            {
                                                "Ref": "CodeS3BucketParameter"
                                            },
                                            "/",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            "/bootstrap.sh,",
                                            {
                                                "Ref": "DataSourceSchemaVersion"
                                            },
                                            ",",
                                            {
                                                "Ref": "CodeS3BucketParameter"
                                            },
                                            "/",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            ",",
                                            {
                                                "Ref": "HDTGitTagOrBranchParameter"
                                            },
                                            ",",
                                            {
                                                "Ref": "IntermediateS3Bucket"
                                            },
                                            ",",
                                            {
                                                "Ref": "RedshiftOperationsAccessKey"
                                            },
                                            ",",
                                            {
                                                "Fn::GetAtt": [
                                                    "RedshiftOperationsAccessKey",
                                                    "SecretAccessKey"
                                                ]
                                            },
                                            ",",
                                            {
                                                "Ref": "NewCodeS3Bucket"
                                            },
                                            ",",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            }
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "configuration",
                                "RefValue": "EmrConfigHiveSite"
                            },
                            {
                                "Key": "configuration",
                                "RefValue": "EmrConfigHiveLog4J"
                            }
                        ]
                    },
                    {
                        "Id": "InputOutputDataFormat",
                        "Name": "InputOutputDataFormat",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "TSV"
                            }
                        ]
                    },
                    {
                        "Id": "RedshiftIdentityUnload",
                        "Name": "RedshiftIdentityUnload",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SqlActivity"
                            },
                            {
                                "Key": "database",
                                "RefValue": "RedshiftDatabase"
                            },
                            {
                                "Key": "script",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "UNLOAD ('SELECT * FROM identity_map') TO 's3://",
                                            {
                                                "Ref": "IncomingS3Bucket"
                                            },
                                            "/dataset-path-placeholder/identity_map/' CREDENTIALS 'aws_access_key_id=",
                                            {
                                                "Ref": "RedshiftOperationsAccessKey"
                                            },
                                            ";aws_secret_access_key=",
                                            {
                                                "Fn::GetAtt": [
                                                    "RedshiftOperationsAccessKey",
                                                    "SecretAccessKey"
                                                ]
                                            },
                                            "' DELIMITER '\t' GZIP;"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendRedshiftIdentityUnloadSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendRedshiftIdentityUnloadFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendRedshiftIdentityUnloadSuccessSNSMessage",
                        "Name": "SendRedshiftIdentityUnloadSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Redshift identity unload succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendRedshiftIdentityUnloadFailureSNSMessage",
                        "Name": "SendRedshiftIdentityUnloadFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Redshift identity unload failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "MoveDataToHDFS",
                        "Name": "MoveDataToHDFS",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "s3-dist-cp --src=s3://",
                                            {
                                                "Ref": "IncomingS3Bucket"
                                            },
                                            "/dataset-path-placeholder --dest=hdfs:///phase_0 --outputCodec=none"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RedshiftIdentityUnload"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendMoveDataToHDFSSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendMoveDataToHDFSFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendMoveDataToHDFSSuccessSNSMessage",
                        "Name": "SendMoveDataToHDFSSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Move Data to HDFS succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendMoveDataToHDFSFailureSNSMessage",
                        "Name": "SendMoveDataToHDFSFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Move Data to HDFS failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase1PreVerifyJAR",
                        "Name": "RunPhase1PreVerifyJAR",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrActivity"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "MoveDataToHDFS"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase1PreVerifySuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase1PreVerifyFailureSNSMessage"
                            },
                            {
                                "Key": "step",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/data_tools.jar,edu.harvard.data.",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            ".cli.",
                                            {
                                                "Ref": "InitcapsDatasourceParameter"
                                            },
                                            "DataCli,preverify,1,-in,hdfs:///phase_0,-out,hdfs:///verify/phase_1"
                                        ]
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase1PreVerifySuccessSNSMessage",
                        "Name": "SendPhase1PreVerifySuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 1 Pre-Verify script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase1PreVerifyFailureSNSMessage",
                        "Name": "SendPhase1PreVerifyFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 1 Pre-Verify script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase1HadoopJAR",
                        "Name": "RunPhase1HadoopJAR",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrActivity"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase1PreVerifyJAR"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase1HadoopSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase1HadoopFailureSNSMessage"
                            },
                            {
                                "Key": "step",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/data_tools.jar,edu.harvard.data.",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            ".cli.",
                                            {
                                                "Ref": "InitcapsDatasourceParameter"
                                            },
                                            "DataCli,hadoop,1,/phase_0,/phase_1"
                                        ]
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase1HadoopSuccessSNSMessage",
                        "Name": "SendPhase1HadoopSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 1 Hadoop script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase1HadoopFailureSNSMessage",
                        "Name": "SendPhase1HadoopFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 1 Hadoop script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase1MoveCommand",
                        "Name": "RunPhase1MoveCommand",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": "/home/hadoop/phase_1_move_unmodified_files.sh phase_0 phase_1"
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase1HadoopJAR"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase1MoveSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase1MoveFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase1MoveSuccessSNSMessage",
                        "Name": "SendPhase1MoveSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 1 move script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase1MoveFailureSNSMessage",
                        "Name": "SendPhase1MoveFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 1 move script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase1PostVerifyJAR",
                        "Name": "RunPhase1PostVerifyJAR",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrActivity"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase1MoveCommand"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase1PostVerifySuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase1PostVerifyFailureSNSMessage"
                            },
                            {
                                "Key": "step",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/data_tools.jar,edu.harvard.data.",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            ".cli.",
                                            {
                                                "Ref": "InitcapsDatasourceParameter"
                                            },
                                            "DataCli,postverify,1,-in,hdfs:///phase_0,-out,hdfs:///phase_1,-verify,hdfs:///verify/phase_1"
                                        ]
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase1PostVerifySuccessSNSMessage",
                        "Name": "SendPhase1PostVerifySuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 1 Post-Verify script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase1PostVerifyFailureSNSMessage",
                        "Name": "SendPhase1PostVerifyFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 1 Post-Verify script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "MoveIdentityMapFromHDFS",
                        "Name": "MoveIdentityMapFromHDFS",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "s3-dist-cp --src=hdfs:///phase_1/identity_map --outputCodec=gzip --dest=s3://",
                                            {
                                                "Ref": "IntermediateS3Bucket"
                                            },
                                            "/dataset-path-placeholder/identity_map"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase1PostVerifyJAR"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendMoveIdentityMapFromHDFSSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendMoveIdentityMapFromHDFSFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendMoveIdentityMapFromHDFSSuccessSNSMessage",
                        "Name": "SendMoveIdentityMapFromHDFSSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Move Identity Map from HDFS succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendMoveIdentityMapFromHDFSFailureSNSMessage",
                        "Name": "SendMoveIdentityMapFromHDFSFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Move Identity Map from HDFS failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "S3toRedshiftIdentityLoad",
                        "Name": "S3toRedshiftIdentityLoad",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SqlActivity"
                            },
                            {
                                "Key": "database",
                                "RefValue": "RedshiftDatabase"
                            },
                            {
                                "Key": "script",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "DROP TABLE IF EXISTS identity_map_stage;\n",
                                            "CREATE TABLE identity_map_stage (LIKE identity_map);\n",
                                            "COPY identity_map_stage (research_id, huid, xid, canvas_id, canvas_data_id) FROM 's3://",
                                            {
                                                "Ref": "IntermediateS3Bucket"
                                            },
                                            "/dataset-path-placeholder/identity_map/' CREDENTIALS 'aws_access_key_id=",
                                            {
                                                "Ref": "RedshiftOperationsAccessKey"
                                            },
                                            ";aws_secret_access_key=",
                                            {
                                                "Fn::GetAtt": [
                                                    "RedshiftOperationsAccessKey",
                                                    "SecretAccessKey"
                                                ]
                                            },
                                            "' DELIMITER '\t' TRUNCATECOLUMNS GZIP;\n",
                                            "BEGIN TRANSACTION;\n",
                                            "DELETE FROM identity_map USING identity_map_stage WHERE identity_map.research_id = identity_map_stage.research_id;\n",
                                            "INSERT INTO identity_map SELECT * FROM identity_map_stage;\n",
                                            "END TRANSACTION;\n",
                                            "DROP TABLE identity_map_stage;\n",
                                            "VACUUM identity_map;\n",
                                            "ANALYZE identity_map;\n"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "MoveIdentityMapFromHDFS"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendS3toRedshiftIdentityLoadSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendS3toRedshiftIdentityLoadFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendS3toRedshiftIdentityLoadSuccessSNSMessage",
                        "Name": "SendS3toRedshiftIdentityLoadSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - S3 to Redshift identity_map load succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendS3toRedshiftIdentityLoadFailureSNSMessage",
                        "Name": "SendS3toRedshiftIdentityLoadFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - S3 to Redshift identity_map load failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase2PreVerifyJAR",
                        "Name": "RunPhase2PreVerifyJAR",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrActivity"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "S3toRedshiftIdentityLoad"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase2PreVerifySuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase2PreVerifyFailureSNSMessage"
                            },
                            {
                                "Key": "step",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/data_tools.jar,edu.harvard.data.",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            ".cli.",
                                            {
                                                "Ref": "InitcapsDatasourceParameter"
                                            },
                                            "DataCli,preverify,2,-in,hdfs:///phase_1,-out,hdfs:///verify/phase_2"
                                        ]
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2PreVerifySuccessSNSMessage",
                        "Name": "SendPhase2PreVerifySuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 Pre-Verify script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2PreVerifyFailureSNSMessage",
                        "Name": "SendPhase2PreVerifyFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 Pre-Verify script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase2CreateCommand",
                        "Name": "RunPhase2CreateCommand",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": "/home/hadoop/phase_2_create_tables.sh"
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase2PreVerifyJAR"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase2CreateSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase2CreateFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2CreateSuccessSNSMessage",
                        "Name": "SendPhase2CreateSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 create tables script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2CreateFailureSNSMessage",
                        "Name": "SendPhase2CreateFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 create tables script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase2HiveCommand",
                        "Name": "RunPhase2HiveCommand",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/phase_2_hive.sh /home/hadoop/harvard-data-tools/hive/",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            "/phase_2"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase2CreateCommand"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase2HiveSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase2HiveFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2HiveSuccessSNSMessage",
                        "Name": "SendPhase2HiveSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 Hive command succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2HiveFailureSNSMessage",
                        "Name": "SendPhase2HiveFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 Hive command failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase2HadoopJAR",
                        "Name": "RunPhase2HadoopJAR",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrActivity"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase2CreateCommand"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase2HadoopSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase2HadoopFailureSNSMessage"
                            },
                            {
                                "Key": "step",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/data_tools.jar,edu.harvard.data.",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            ".cli.",
                                            {
                                                "Ref": "InitcapsDatasourceParameter"
                                            },
                                            "DataCli,hadoop,2,/phase_1,/phase_2"
                                        ]
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2HadoopSuccessSNSMessage",
                        "Name": "SendPhase2HadoopSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 Hadoop script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2HadoopFailureSNSMessage",
                        "Name": "SendPhase2HadoopFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 Hadoop script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase2MoveCommand",
                        "Name": "RunPhase2MoveCommand",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": "/home/hadoop/phase_2_move_unmodified_files.sh phase_1 phase_2"
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase2HiveCommand"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase2HadoopJAR"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase2MoveSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase2MoveFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2MoveSuccessSNSMessage",
                        "Name": "SendPhase2MoveSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 move script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2MoveFailureSNSMessage",
                        "Name": "SendPhase2MoveFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 move script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase2PostVerifyJAR",
                        "Name": "RunPhase2PostVerifyJAR",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrActivity"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase2MoveCommand"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase2PostVerifySuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase2PostVerifyFailureSNSMessage"
                            },
                            {
                                "Key": "step",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/data_tools.jar,edu.harvard.data.",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            ".cli.",
                                            {
                                                "Ref": "InitcapsDatasourceParameter"
                                            },
                                            "DataCli,postverify,2,-in,hdfs:///phase_1,-out,hdfs:///phase_2,-verify,hdfs:///verify/phase_2"
                                        ]
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2PostVerifySuccessSNSMessage",
                        "Name": "SendPhase2PostVerifySuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 Post-Verify script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase2PostVerifyFailureSNSMessage",
                        "Name": "SendPhase2PostVerifyFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 2 Post-Verify script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase3PreVerifyJAR",
                        "Name": "RunPhase3PreVerifyJAR",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrActivity"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase2PostVerifyJAR"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase3PreVerifySuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase3PreVerifyFailureSNSMessage"
                            },
                            {
                                "Key": "step",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/data_tools.jar,edu.harvard.data.",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            ".cli.",
                                            {
                                                "Ref": "InitcapsDatasourceParameter"
                                            },
                                            "DataCli,preverify,3,-in,hdfs:///phase_2,-out,hdfs:///verify/phase_3"
                                        ]
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3PreVerifySuccessSNSMessage",
                        "Name": "SendPhase3PreVerifySuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 Pre-Verify script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3PreVerifyFailureSNSMessage",
                        "Name": "SendPhase3PreVerifyFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 Pre-Verify script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase3CreateCommand",
                        "Name": "RunPhase3CreateCommand",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": "/home/hadoop/phase_3_create_tables.sh"
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase3PreVerifyJAR"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase3CreateSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase3CreateFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3CreateSuccessSNSMessage",
                        "Name": "SendPhase3CreateSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 create tables script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3CreateFailureSNSMessage",
                        "Name": "SendPhase3CreateFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 create tables script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase3HiveCommand",
                        "Name": "RunPhase3HiveCommand",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/phase_3_hive.sh /home/hadoop/harvard-data-tools/hive/",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            "/phase_3"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase3CreateCommand"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase3HiveSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase3HiveFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3HiveSuccessSNSMessage",
                        "Name": "SendPhase3HiveSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 Hive command succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3HiveFailureSNSMessage",
                        "Name": "SendPhase3HiveFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 Hive command failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase3HadoopJAR",
                        "Name": "RunPhase3HadoopJAR",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrActivity"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase3CreateCommand"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase3HadoopSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase3HadoopFailureSNSMessage"
                            },
                            {
                                "Key": "step",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/data_tools.jar,edu.harvard.data.",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            ".cli.",
                                            {
                                                "Ref": "InitcapsDatasourceParameter"
                                            },
                                            "DataCli,hadoop,3,/phase_2,/phase_3"
                                        ]
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3HadoopSuccessSNSMessage",
                        "Name": "SendPhase3HadoopSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 Hadoop script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3HadoopFailureSNSMessage",
                        "Name": "SendPhase3HadoopFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 Hadoop script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase3MoveCommand",
                        "Name": "RunPhase3MoveCommand",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": "/home/hadoop/phase_3_move_unmodified_files.sh phase_2 phase_3"
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase3HiveCommand"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase3HadoopJAR"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase3MoveSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase3MoveFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3MoveSuccessSNSMessage",
                        "Name": "SendPhase3MoveSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 move script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3MoveFailureSNSMessage",
                        "Name": "SendPhase3MoveFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 move script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunPhase3PostVerifyJAR",
                        "Name": "RunPhase3PostVerifyJAR",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrActivity"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase3MoveCommand"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendPhase3PostVerifySuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendPhase3PostVerifyFailureSNSMessage"
                            },
                            {
                                "Key": "step",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/data_tools.jar,edu.harvard.data.",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            ".cli.",
                                            {
                                                "Ref": "InitcapsDatasourceParameter"
                                            },
                                            "DataCli,postverify,3,-in,hdfs:///phase_2,-out,hdfs:///phase_3,-verify,hdfs:///verify/phase_3"
                                        ]
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3PostVerifySuccessSNSMessage",
                        "Name": "SendPhase3PostVerifySuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 Post-Verify script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendPhase3PostVerifyFailureSNSMessage",
                        "Name": "SendPhase3PostVerifyFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Phase 3 Post-Verify script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "RunCleanup",
                        "Name": "RunCleanup",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "EmrActivity"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunPhase3PostVerifyJAR"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendCleanupSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendCleanupFailureSNSMessage"
                            },
                            {
                                "Key": "step",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "/home/hadoop/data_tools.jar,edu.harvard.data.",
                                            {
                                                "Ref": "LowercaseDatasourceParameter"
                                            },
                                            ".cli.",
                                            {
                                                "Ref": "InitcapsDatasourceParameter"
                                            },
                                            "DataCli,cleanup"
                                        ]
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendCleanupSuccessSNSMessage",
                        "Name": "SendCleanupSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Cleanup script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendCleanupFailureSNSMessage",
                        "Name": "SendCleanupFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Cleanup script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "MoveDataFromHDFS",
                        "Name": "MoveDataFromHDFS",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "s3-dist-cp --src=hdfs:///phase_3 --outputCodec=gzip --dest=s3://",
                                            {
                                                "Ref": "IntermediateS3Bucket"
                                            },
                                            "/dataset-path-placeholder"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "RunCleanup"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendMoveDataFromHDFSSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendMoveDataFromHDFSFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendMoveDataFromHDFSSuccessSNSMessage",
                        "Name": "SendMoveDataFromHDFSSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Move Data from HDFS succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendMoveDataFromHDFSFailureSNSMessage",
                        "Name": "SendMoveDataFromHDFSFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Move Data from HDFS failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "MoveDatasetToArchives",
                        "Name": "MoveDatasetToArchives",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "aws s3 mv s3://",
                                            {
                                                "Ref": "IncomingS3Bucket"
                                            },
                                            "/dataset-path-placeholder s3://",
                                            {
                                                "Ref": "ArchivalS3Bucket"
                                            },
                                            "/dataset-path-placeholder --recursive"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendMoveDatasetSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendMoveDatasetFailureSNSMessage"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "S3toRedshiftLoad"
                            }
                        ]
                    },
                    {
                        "Id": "SendMoveDatasetSuccessSNSMessage",
                        "Name": "SendMoveDatasetSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Move data to archives succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendMoveDatasetFailureSNSMessage",
                        "Name": "SendMoveDatasetFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Datatset dataset-id-placeholder - Move dataset to archives failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "DeleteS3toRedshiftLoadScript",
                        "Name": "DeleteS3toRedshiftLoadScript",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "aws s3 rm s3://",
                                            {
                                                "Ref": "NewCodeS3Bucket"
                                            },
                                            "/dataset-id-placeholder.sql"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendDeleteS3toRedshiftLoadScriptSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendDeleteS3toRedshiftLoadScriptFailureSNSMessage"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "S3toRedshiftLoad"
                            }
                        ]
                    },
                    {
                        "Id": "SendDeleteS3toRedshiftLoadScriptSuccessSNSMessage",
                        "Name": "SendDeleteS3toRedshiftLoadScriptSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Delete S3-to-Redshift load script succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendDeleteS3toRedshiftLoadScriptFailureSNSMessage",
                        "Name": "SendDeleteS3toRedshiftLoadScriptFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Datatset dataset-id-placeholder - Delete S3-to-Redshift load script failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "DeleteIntermediateS3Data",
                        "Name": "DeleteIntermediateS3Data",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "#aws s3 rm s3://",
                                            {
                                                "Ref": "IntermediateS3Bucket"
                                            },
                                            "/dataset-path-placeholder --recursive"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendDeleteIntermediateS3DataSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendDeleteIntermediateS3DataFailureSNSMessage"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "S3toRedshiftLoad"
                            }
                        ]
                    },
                    {
                        "Id": "SendDeleteIntermediateS3DataSuccessSNSMessage",
                        "Name": "SendDeleteIntermediateS3DataSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Delete intermediate S3 data succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendDeleteIntermediateS3DataFailureSNSMessage",
                        "Name": "SendDeleteIntermediateS3DataFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Datatset dataset-id-placeholder - Delete intermediate S3 data failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "DeletePipeline",
                        "Name": "DeletePipeline",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "ShellCommandActivity"
                            },
                            {
                                "Key": "command",
                                "StringValue": "dpid=$(aws ec2 describe-tags --filters \"Name=resource-id,Values=$(curl http://169.254.169.254/latest/meta-data/instance-id)\" \"Name=key,Values=datapipeline-id\" --query 'Tags[*].[Value]' --output text --region us-east-1); aws datapipeline delete-pipeline --pipeline-id $dpid --region us-east-1"
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "DeleteS3toRedshiftLoadScript"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "DeleteIntermediateS3Data"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "MoveDatasetToArchives"
                            }
                        ]
                    },
                    {
                        "Id": "RedshiftDatabase",
                        "Name": "RedshiftDatabase",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "RedshiftDatabase"
                            },
                            {
                                "Key": "clusterId",
                                "StringValue": {
                                    "Ref": "RedshiftClusterParameter"
                                }
                            },
                            {
                                "Key": "username",
                                "StringValue": {
                                    "Ref": "RedshiftMasterUserNameParameter"
                                }
                            },
                            {
                                "Key": "*password",
                                "StringValue": {
                                    "Ref": "RedshiftMasterUserPasswordParameter"
                                }
                            },
                            {
                                "Key": "databaseName",
                                "StringValue": {
                                    "Ref": "RedshiftMasterUserNameParameter"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "S3toRedshiftLoad",
                        "Name": "S3toRedshiftLoad",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SqlActivity"
                            },
                            {
                                "Key": "database",
                                "RefValue": "RedshiftDatabase"
                            },
                            {
                                "Key": "scriptUri",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "s3://",
                                            {
                                                "Ref": "NewCodeS3Bucket"
                                            },
                                            "/dataset-id-placeholder.sql"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "schedule",
                                "RefValue": "DefaultSchedule"
                            },
                            {
                                "Key": "runsOn",
                                "RefValue": "EmrCluster"
                            },
                            {
                                "Key": "retryDelay",
                                "StringValue": "2 Minutes"
                            },
                            {
                                "Key": "dependsOn",
                                "RefValue": "MoveDataFromHDFS"
                            },
                            {
                                "Key": "onSuccess",
                                "RefValue": "SendLoadRedshiftSuccessSNSMessage"
                            },
                            {
                                "Key": "onFail",
                                "RefValue": "SendLoadRedshiftFailureSNSMessage"
                            }
                        ]
                    },
                    {
                        "Id": "SendLoadRedshiftSuccessSNSMessage",
                        "Name": "SendLoadRedshiftSuccessSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Redshift load succeeded"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Yay!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "SuccessSNS"
                                }
                            }
                        ]
                    },
                    {
                        "Id": "SendLoadRedshiftFailureSNSMessage",
                        "Name": "SendLoadRedshiftFailureSNSMessage",
                        "Fields": [
                            {
                                "Key": "type",
                                "StringValue": "SnsAlarm"
                            },
                            {
                                "Key": "role",
                                "StringValue": {
                                    "Ref": "DataPipelineRole"
                                }
                            },
                            {
                                "Key": "subject",
                                "StringValue": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "-",
                                            {
                                                "Ref": "EnvironmentParameter"
                                            },
                                            " Dataset dataset-id-placeholder - Redshift load failed"
                                        ]
                                    ]
                                }
                            },
                            {
                                "Key": "message",
                                "StringValue": "Boo!"
                            },
                            {
                                "Key": "topicArn",
                                "StringValue": {
                                    "Ref": "FailureSNS"
                                }
                            }
                        ]
                    }
                ]
            }
        },
        "DumpStatusDynamoDBTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "AttributeDefinitions": [
                    {
                        "AttributeName": "id",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "id"
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": "5",
                    "WriteCapacityUnits": "5"
                },
                "TableName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            "-",
                            {
                                "Ref": "EnvironmentParameter"
                            },
                            "-dump-status"
                        ]
                    ]
                }
            }
        },
        "TableInfoDynamoDBTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "AttributeDefinitions": [
                    {
                        "AttributeName": "name",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "KeyType": "HASH",
                        "AttributeName": "name"
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": "5",
                    "WriteCapacityUnits": "5"
                },
                "TableName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            "-",
                            {
                                "Ref": "EnvironmentParameter"
                            },
                            "-table-info"
                        ]
                    ]
                }
            }
        }
    },
    "Outputs": {
        "IncomingS3Bucket": {
            "Description": "Incoming S3 Bucket",
            "Value": {
                "Ref": "IncomingS3Bucket"
            }
        },
        "ArchivalS3Bucket": {
            "Description": "Archival S3 Bucket",
            "Value": {
                "Ref": "ArchivalS3Bucket"
            }
        },
        "DataPipelineInitLambdaRole": {
            "Description": "DataPipelineInitLambda IAM Role",
            "Value": {
                "Ref": "DataPipelineInitLambdaRole"
            }
        },
        "DataPipelineId": {
            "Description": "Data Pipeline Id",
            "Value": {
                "Ref": "Pipeline"
            }
        },
        "Phase0ASGName": {
            "Description": "Phase0ASG Name",
            "Value": {
                "Ref": "Phase0ASG"
            }
        },
        "Phase0LambdaFunction": {
            "Description": "Phase0Lambda Function",
            "Value": {
                "Ref": "Phase0Lambda"
            }
        },
        "DataPipelineInitLambdaFunction": {
            "Description": "DataPipelineInitLambda Function",
            "Value": {
                "Ref": "DataPipelineInitLambda"
            }
        },
        "DatabaseInstance": {
            "Description": "Redshift Database",
            "Value": {
                "Ref": "RedshiftClusterParameter"
            }
        },
        "DumpStatusDynamoTable": {
            "Description": "DumpStatus DynamoDB Table",
            "Value": {
                "Ref": "DumpStatusDynamoDBTable"
            }
        },
        "TableInfoDynamoTable": {
            "Description": "TableInfo DynamoDB Table",
            "Value": {
                "Ref": "TableInfoDynamoDBTable"
            }
        },
        "SuccessSNSARN": {
            "Description": "Success SNS ARN",
            "Value": {
                "Ref": "SuccessSNS"
            }
        },
        "FailureSNSARN": {
            "Description": "Failure SNS ARN",
            "Value": {
                "Ref": "FailureSNS"
            }
        }
    }
}